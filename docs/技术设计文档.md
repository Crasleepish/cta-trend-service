# CTA 趋势追踪策略服务技术设计文档（TDD）— 极简版（V1）

> 技术栈：FastAPI + PostgreSQL + uv + app.yaml  
> 计算细节原则：本文**不展开任何公式/口径/参数选择**；涉及计算逻辑处统一以 **[WP §x]** 引用白皮书章节作为权威来源。 :contentReference[oaicite:0]{index=0}

---

## 1. 约束与假设（你补充的七条，固化为系统约束）

### 1.1 数据来源约束（只读输入）
- 行情数据、因子收益、指数行情、基金净值：**由其它服务生成并已在 PostgreSQL 中**。
- 本服务：**只读取这些输入表**，不负责抓取/清洗/计算这些基础数据。  
  - 趋势/波动率/倾斜等计算所需的时间序列输入定义见白皮书数据层描述 [WP §2][WP §4][WP §6]

### 1.2 可观测性约束
- 仅使用**本地日志**：按日滚动、gzip 归档、保留 1 年；其它（Prometheus/Tracing）忽略。

### 1.3 部署与环境约束
- 使用 **uv** 管理环境。
- **不使用 async worker**（无 Celery/RQ 等）。
- 使用项目配置文件 **app.yaml** 管理配置与密钥。

---

## 2. 总体架构

### 2.1 组件
- **FastAPI（API + 同步执行器）**
  - 查询接口（前端/CLI 读取）
  - 触发计算接口（同步执行）
- **PostgreSQL（输入只读 + 输出落库）**
  - 输入表：由其它服务维护（本服务只读）
  - 输出表：由本服务写入（features / signals / weights / runs）
- **本地日志（文件）**
- **CLI Runner（可选，但推荐）**
  - 与 API 使用同一套 domain service
  - 便于用 cron/systemd 定时跑周度/日度流水线（不需要异步队列）

### 2.2 数据流（V1）
1) 从 DB 读取输入时间序列（行情/因子/指数/基金净值等）  
2) 计算日频特征，并按周频采样（不展开，引用白皮书）[WP §4][WP §6][WP §11]  
3) 生成周频信号与组合权重（不展开，引用白皮书）[WP §7][WP §8][WP §9][WP §10]  
4) 写入 `feature_daily` / `signal_weekly` / `portfolio_weight_weekly`（及 run/audit 表）

---

## 3. 模块拆分（仅保留必要模块）

> 计算细节全部引用白皮书；模块职责只描述“编排与数据契约”。

### 3.1 Repository（数据访问层）
- 只负责 SQL 查询与写入，不含业务逻辑
- 读取：输入表（其它服务产出）
- 写入：本服务输出表 + 运行审计

### 3.2 Feature Service
- 读取输入时间序列
- 计算 **日频 features** 并落库到 `feature_daily`
- 如果白皮书要求“日频计算、周频采样”，则输出对应的周采样表或字段（按白皮书的 timing contract）[WP §11.1][WP §4.1][WP §6.1]

### 3.3 Signal Service（可合并到 Portfolio Service，V1 允许合并以减代码）
- 将 features 映射为周频信号并落库到 `signal_weekly`  
- 因子倾斜相关的输入输出契约引用白皮书 [WP §9]

### 3.4 Portfolio Service
- 根据周频信号生成 `portfolio_weight_weekly`
- 包含 defensive allocation（RATE/CASH）与风险预算/缩放等逻辑的“编排入口”，细节引用白皮书 [WP §8]
- 如包含执行与控制层（死区、最小持有期、EWMA 等），其口径引用白皮书 [WP §10]

### 3.5 Run Service（运行与审计）
- 生成 `run_id`
- 记录输入范围、版本、配置快照、输出摘要、错误栈

---

## 4. 数据库设计（V1 最小集合）

### 4.1 输入表（只读，示意）
> 这些表由其它服务维护；具体字段以现有 DB 为准，本服务只要求能查询到白皮书需要的输入序列 [WP §2]

- `index_hist`（指数/代表性价格序列）
- `market_factors`（日频因子收益，如 MKT/SMB/HML/QMJ/VOL）
- `fund_hist`（基金净值）
- `fund_beta`（基金因子暴露）

### 4.2 输出表（本服务维护）

#### 4.2.1 特征
- `feature_daily`
  - PK：`(strategy_id, version, instrument_id, calc_date, feature_name)`
  - `value`
  - `meta_json`（可存窗口/参数 id，不写公式）

#### 4.2.2 周频信号
- `signal_weekly`
  - PK：`(strategy_id, version, instrument_id, rebalance_date, signal_name)`
  - `value`
  - `meta_json`

#### 4.2.3 周频权重
- `portfolio_weight_weekly`
  - PK：`(strategy_id, version, portfolio_id, rebalance_date, instrument_id)`
  - `target_weight`
  - `bucket`
  - `meta_json`

#### 4.2.4 运行审计
- `job_run`
  - `run_id` (PK)
  - `job_type`（FEATURE / SIGNAL / PORTFOLIO / FULL）
  - `strategy_id, version, snapshot_id`
  - `status`（SUCCESS/FAILED）
  - `time_start, time_end`
  - `input_range_json`
  - `output_summary_json`
  - `error_stack`

> 幂等策略：输出表用主键 + upsert；同一 `(strategy_id, version, date)` 重跑覆盖同键范围，保证可复现。

---

## 5. 配置管理（app.yaml）

### 5.1 配置文件原则
- **app.yaml 是唯一配置入口**：数据库 DSN、密钥、策略默认参数、日志目录等
- 支持环境覆盖：`app.dev.yaml / app.prod.yaml` 或通过环境变量指定路径

### 5.2 建议结构（示意）
```yaml
env: prod

db:
  dsn: "postgresql+psycopg://user:pass@host:5432/cta"
  schema_in: "public"
  schema_out: "cta"

logging:
  dir: "./logs"
  level: "INFO"
  rotate: "daily"
  retention_days: 365
  compress: "gzip"

strategy:
  default_strategy_id: "cta_trend_v1"
  default_version: "1.0.0"
  portfolio_id: "main"

  # 参数不在本文展开；仅做“键存在”，解释与取值依据在白皮书
  params_ref:
    timing_contract: "WP §11.1"
    trend_core: "WP §4"
    volatility: "WP §6"
    raw_weight: "WP §7"
    vol_target_defensive: "WP §8"
    intra_bucket_tilt: "WP §9"
    execution_control: "WP §10"
````

---

## 6. 执行方式（无 async worker）

### 6.1 两种运行模式（V1 推荐同时支持，但都很简单）

1. **API 同步触发（最简）**

   * `POST /jobs/full?rebalance_date=YYYY-MM-DD`
   * 服务内同步跑完并返回 `run_id + summary`（适合小规模/内网）
2. **CLI Runner + cron（更稳）**

   * `python -m app.cli run-full --rebalance-date ...`
   * cron 触发；API 只做查询与状态查看

> 两种模式共用同一套 domain service；无队列、无后台 worker。

### 6.2 Job 类型（V1）

* `FULL`：feature → signal → portfolio 一条龙
* 也保留拆分：

  * `FEATURE`
  * `SIGNAL`
  * `PORTFOLIO`

---

## 7. API 设计（V1 最小可用）

> 初版无鉴权：仅做功能；默认部署在受控网络。

### 7.1 查询类（前端必用）

* `GET /health`
* `GET /weights/latest?portfolio_id=...`
* `GET /weights?portfolio_id=...&rebalance_date=...`
* `GET /signals?rebalance_date=...`
* `GET /features?calc_date=...&instrument_id=...`
* `GET /runs?limit=...`
* `GET /runs/{run_id}`

### 7.2 触发类（内网运维/手工跑）

* `POST /jobs/full`

  * 入参：`strategy_id, version, snapshot_id?, rebalance_date, lookback_range?`
  * 返回：`run_id, status, output_summary`
* `POST /jobs/feature`
* `POST /jobs/portfolio`

---

## 8. 本地日志方案（满足“按日滚动 + gzip + 保留一年”）

### 8.1 约束落实

* 使用 Python logging + `TimedRotatingFileHandler`
* 每日切分：`app_YYYY-MM-DD.log`
* 归档压缩：切分后 gzip
* 清理策略：启动时/每日首次写日志时清理超过 365 天文件

### 8.2 必须打印的关键字段

* `run_id`, `job_type`, `strategy_id`, `version`, `snapshot_id`
* `rebalance_date`, `calc_date_range`
* 每个 step 的：`duration_ms`, `rows_read`, `rows_written`

---

## 9. 算法测试（新增：校验数据公式）

> 目标：不仅测“有输出”，还要测“输出数值与白皮书公式一致”。
> 说明：白皮书是唯一权威，测试用例以章节为组织单位。

### 9.1 测试分层

1. **公式单元测试（Formula Unit Tests）**

   * 每个公式/定义一组小样本输入 → 期望输出（人工可复核）
   * 覆盖：趋势强度、波动率年化、门控/滞回、raw weight 组成、组合缩放、防御分配、intra-bucket tilt 映射等
   * 引用：

     * 趋势强度与门控 [WP §4.1][WP §4.2]
     * 波动率年化与过滤 [WP §6.1][WP §6.3]
     * raw weight [WP §7]
     * 组合层与防御 [WP §8]
     * 倾斜层 [WP §9]
     * 执行与控制（若 V1 实现）[WP §10]
2. **端到端一致性测试（E2E Determinism Tests）**

   * 固定输入数据范围 + 固定 snapshot → 两次运行 outputs hash 完全一致（可复现）
3. **回归测试（Golden Files）**

   * 保存一小段基准数据与基准输出（features/signals/weights），任何改动必须显式更新基准并记录原因（对应白皮书版本变更）

### 9.2 测试数据策略

* 使用最小 fixtures（例如 2 个 bucket、10~30 个交易日、2~4 个因子）
* 所有 fixtures 落在 `tests/fixtures/`，避免依赖线上 DB
* 另提供可选“连接测试 DB”的集成测试（但不是必需）

### 9.3 覆盖标准（V1 建议）

* 每个白皮书核心章节至少一组“公式测试”：

  * §4、§6、§7、§8、§9（若实现 §10 也要测）
* 关键边界条件：

  * `S_t = 0`（全部 risk bucket 关闭）[WP §8.1]
  * 极低波动率（`sigma_eff` 生效）[WP §6.2]
  * 高波动率（`f(sigma)` 抑制）[WP §6.3]
  * 倾斜向量为 0、暴露向量为 0（cosine 稳定项）[WP §9.4]

---

## 10. 目录结构（V1 建议）

```
src/
  main.py                 # FastAPI 入口
  api/                    # 路由
  core/
    config.py             # 读取 app.yaml
    logging.py            # 日志滚动/压缩/清理
    db.py                 # DB session/engine
  repo/                   # 数据访问层
  services/
    feature_service.py
    portfolio_service.py
    run_service.py
  cli.py                  # 可选：命令行 runner
tests/
  fixtures/
  formula/
  e2e/
migrations/               # Alembic（只对输出表与run表）
app.yaml
pyproject.toml            # uv 管理
```

---

## 11. 白皮书引用映射（V1 必须用到的“计算定义指针”）

| 主题                              | 本服务模块              | 白皮书引用                       |
| ------------------------------- | ------------------ | --------------------------- |
| 分层与依赖规则                         | 全局                 | [WP §2]                     |
| 趋势定义与门控（滞回）                     | Feature/Portfolio  | [WP §4.1][WP §4.2]          |
| 波动率年化、sigma_eff、f(sigma)        | Feature/Portfolio  | [WP §6.1][WP §6.2][WP §6.3] |
| raw weight 合成                   | Portfolio          | [WP §7]                     |
| 组合层：风险预算/波动率上限/防御分配             | Portfolio          | [WP §8]                     |
| 倾斜层（因子驱动 bucket 内再分配）           | Portfolio（若 V1 实现） | [WP §9]                     |
| 执行与控制（最小持有/死区/EWMA）             | Portfolio（若 V1 实现） | [WP §10]                    |
| timing contract（日频计算、周频采样、执行对齐） | 全局                 | [WP §11.1]                  |
